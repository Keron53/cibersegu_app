@startuml
top to bottom direction
skinparam packageStyle rectangle
skinparam componentStyle rectangle
skinparam backgroundColor #FFFFFF
skinparam component {
  BackgroundColor #E8F4FD
  BorderColor #2E86AB
}
skinparam database {
  BackgroundColor #F0F8FF
  BorderColor #4682B4
}

title Flujo Principal del Usuario - Sistema Cibersegu

actor "Usuario" as User

rectangle "Frontend (React)" as FE {
  component "Registro/Login" as Auth
  component "Dashboard" as Dashboard
  component "Subir Documento" as Upload
  component "Visor PDF" as PDFViewer
  component "Solicitar Firma" as Request
  component "Notificaciones" as Notifications
}

package "Backend (Node.js)" {
  component "AutenticaciÃ³n" as AuthAPI
  component "Documentos" as DocAPI
  component "Firmas" as SignAPI
  component "Email" as EmailAPI
}

package "Servicios" {
  component "Firma Digital\n(pyHanko)" as PyHanko
  component "Base de Datos" as DB
  component "Gmail" as Gmail
}

' === FLUJO PRINCIPAL DEL USUARIO ===

' 1. REGISTRO E INICIO DE SESIÃ“N
User --> Auth : 1. Registro/Login
Auth --> AuthAPI : POST /api/usuarios/registro
AuthAPI --> EmailAPI : Enviar cÃ³digo verificaciÃ³n
EmailAPI --> Gmail : Email de verificaciÃ³n
AuthAPI --> DB : Guardar usuario
AuthAPI --> Auth : Token JWT
Auth --> Dashboard : 2. Ir al Dashboard

' 2. SUBIR DOCUMENTO
User --> Dashboard : 3. Subir documento
Dashboard --> Upload : Abrir formulario
Upload --> DocAPI : POST /api/documentos/subir
DocAPI --> DB : Guardar documento
DocAPI --> Upload : ConfirmaciÃ³n
Upload --> PDFViewer : 4. Abrir visor PDF

' 3. POSICIONAR Y FIRMAR
User --> PDFViewer : 5. Seleccionar posiciÃ³n
PDFViewer --> SignAPI : POST /api/documentos/:id/firmar
SignAPI --> PyHanko : Procesar firma digital
PyHanko --> SignAPI : PDF firmado
SignAPI --> PDFViewer : Descargar PDF
PDFViewer --> Dashboard : 6. Volver al Dashboard

' 4. SOLICITAR FIRMA A OTROS
User --> Dashboard : 7. Solicitar firma
Dashboard --> Request : Abrir formulario
Request --> SignAPI : POST /api/solicitudes-multiples/crear
SignAPI --> EmailAPI : Notificar firmantes
EmailAPI --> Gmail : Emails con enlaces
SignAPI --> DB : Guardar solicitud
Request --> Notifications : 8. Esperar notificaciones

' 5. NOTIFICACIONES EN TIEMPO REAL
Notifications --> User : 9. Actualizaciones en tiempo real
User --> Dashboard : Ver progreso de firmas

' === ESTADOS DEL DOCUMENTO ===
note right of Dashboard
  Estados del Documento:
  ğŸ“„ Sin firmar
  âœï¸ Firmado por mÃ­
  ğŸ‘¥ Con solicitudes pendientes
  âœ… Completamente firmado
end note

' === TIPOS DE FIRMA ===
note left of PDFViewer
  Tipos de Firma:
  ğŸ” Firma individual
  ğŸ‘¥ Solicitud mÃºltiple (hasta 5)
  ğŸ“§ Notificaciones por email
  ğŸ”” Actualizaciones en tiempo real
end note

@enduml
